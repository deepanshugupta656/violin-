<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Diya's Violin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@400;700&display=swap');

        :root {
            --wood-dark: #3e2723;
            --wood-light: #5d4037;
            --wood-varnish: #8d6e63;
            --string-color: #c0c0c0;
            --fingerboard: #1a1a1a;
        }

        body {
            background: radial-gradient(circle at center, #2c1e1a 0%, #0f0a08 100%);
            font-family: 'Lato', sans-serif;
            overflow: hidden;
            touch-action: none;
        }

        .wood-texture {
            background-color: var(--wood-varnish);
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%233e2723' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E");
            box-shadow: inset 0 0 60px rgba(0,0,0,0.8);
        }

        @keyframes vibrate {
            0% { transform: translateX(0); }
            25% { transform: translateX(-1px); }
            75% { transform: translateX(1px); }
            100% { transform: translateX(0); }
        }

        .string.playing {
            animation: vibrate 0.05s infinite;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
            background-color: #fff;
        }

        .fingerboard-shadow {
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        .marker {
            pointer-events: none;
        }

        .tutorial-target {
            position: absolute;
            width: 24px;
            height: 24px;
            background: radial-gradient(circle, #4ade80 0%, transparent 70%);
            border: 2px solid #4ade80;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 50;
            animation: pulse-target 1.5s infinite;
            box-shadow: 0 0 15px #4ade80;
        }

        @keyframes pulse-target {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
            50% { transform: translate(-50%, -50%) scale(1.3); opacity: 0.4; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
        }

        .tutorial-text {
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        .modal-bg {
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(4px);
        }
        .input-glow:focus {
            box-shadow: 0 0 15px #a855f7;
            border-color: #a855f7;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center text-white">

    <!-- Start Overlay -->
    <div id="start-overlay" class="fixed inset-0 z-50 bg-black/90 flex flex-col items-center justify-center cursor-pointer transition-opacity duration-500">
        <h1 class="font-['Cinzel'] text-5xl md:text-7xl text-amber-500 mb-4">Diya's Violin</h1>
        <p class="text-gray-300 text-xl mb-8 text-center px-4">Click or Tap anywhere to pick up the bow</p>
        <div class="animate-bounce text-amber-500 text-3xl">&#9660;</div>
    </div>

    <!-- AI Maestro Modal -->
    <div id="ai-modal" class="hidden fixed inset-0 z-40 modal-bg flex items-center justify-center px-4">
        <div class="bg-stone-900 border-2 border-amber-600 rounded-xl p-6 w-full max-w-md shadow-2xl relative">
            <button id="close-modal" class="absolute top-2 right-3 text-gray-400 hover:text-white text-xl">&times;</button>
            
            <h2 class="font-['Cinzel'] text-2xl text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-purple-500 mb-2">
                Ask Maestro AI âœ¨
            </h2>
            <p class="text-stone-400 text-sm mb-4">What song would you like to play?</p>
            
            <input type="text" id="song-request" placeholder="e.g., Abhi Mujh Mein Kahin, Harry Potter..." 
                   class="w-full bg-stone-800 border border-stone-600 rounded p-3 text-white placeholder-stone-500 focus:outline-none input-glow transition-all mb-6">
            
            <div class="grid grid-cols-2 gap-3">
                <button id="btn-teach" class="bg-stone-700 hover:bg-stone-600 text-white font-bold py-3 rounded shadow-lg transition flex flex-col items-center justify-center gap-1 border border-stone-500">
                    <span class="text-lg">ðŸŽ“ Teach Me</span>
                    <span class="text-[10px] text-stone-300 font-normal">Step-by-step Tutorial</span>
                </button>
                
                <button id="btn-perform" class="bg-gradient-to-r from-amber-700 to-purple-800 hover:from-amber-600 hover:to-purple-700 text-white font-bold py-3 rounded shadow-lg transition flex flex-col items-center justify-center gap-1 border border-amber-500/50">
                    <span class="text-lg">ðŸŽ» Perform Full Song</span>
                    <span class="text-[10px] text-stone-200 font-normal">Listen to Diya Play</span>
                </button>
            </div>

            <div id="loading-state" class="hidden mt-4 text-center text-amber-400 flex flex-col items-center gap-2">
                <div class="animate-spin h-6 w-6 border-2 border-amber-400 border-t-transparent rounded-full"></div>
                <span id="loading-text">Composing...</span>
            </div>

            <div id="quick-picks" class="mt-4 flex gap-2 justify-center text-xs text-stone-500 flex-wrap">
                <span>Try:</span>
                <button class="hover:text-amber-400 underline quick-pick">Abhi Mujh Mein Kahin</button>
                <button class="hover:text-amber-400 underline quick-pick">Harry Potter</button>
                <button class="hover:text-amber-400 underline quick-pick">Pirates</button>
            </div>
        </div>
    </div>

    <!-- UI Header -->
    <div class="absolute top-4 left-0 right-0 flex justify-between px-6 pointer-events-none z-20 items-start">
        <div>
            <h2 class="font-['Cinzel'] text-amber-500 text-xl">Diksha</h2>
        </div>
        <div class="pointer-events-auto flex flex-col gap-2 items-end">
            <button id="toggle-markers" class="bg-stone-800 hover:bg-stone-700 border border-stone-600 text-xs px-3 py-1 rounded text-stone-300 transition">
                Toggle Tapes
            </button>
            <div class="flex gap-2 flex-wrap justify-end">
                <button id="stop-btn" class="hidden bg-red-600 hover:bg-red-700 border border-red-400 text-xs px-3 py-1 rounded text-white transition shadow-lg font-bold flex items-center gap-1">
                    <span>&#9632;</span> Stop
                </button>
                
                <button id="start-tutorial" class="bg-amber-700 hover:bg-amber-600 border border-amber-500 text-xs px-3 py-1 rounded text-white transition shadow-lg font-bold">
                    Learn: Twinkle Twinkle
                </button>
                
                <button id="open-ai-modal" class="bg-gradient-to-r from-purple-900 to-indigo-900 hover:from-purple-800 hover:to-indigo-800 border border-purple-500 text-xs px-3 py-1 rounded text-white transition shadow-lg font-bold flex items-center gap-1">
                    Ask Maestro âœ¨
                </button>
            </div>
        </div>
    </div>

    <!-- Tutorial Status Bar -->
    <div id="tutorial-status" class="hidden absolute top-20 left-0 right-0 z-20 text-center pointer-events-none">
        <div class="inline-block bg-black/60 backdrop-blur-md px-6 py-2 rounded-full border border-amber-500/30">
            <span id="tutorial-msg" class="text-amber-400 font-bold text-lg tutorial-text">Prepare to Play...</span>
        </div>
    </div>

    <!-- Main Violin Container -->
    <div class="relative h-[90vh] w-full max-w-md wood-texture rounded-3xl border-4 border-[#2a1b15] shadow-2xl flex flex-col items-center overflow-hidden select-none">
        
        <!-- Scroll Head (Visual only) -->
        <div class="w-full h-24 bg-[#2a1b15] flex justify-center items-end pb-2 relative shadow-lg z-10">
            <div class="w-32 h-4 bg-black rounded-full opacity-50 blur-sm"></div>
            <div class="absolute left-4 top-6 w-8 h-12 bg-[#1a1a1a] rounded-l-lg"></div>
            <div class="absolute right-4 top-6 w-8 h-12 bg-[#1a1a1a] rounded-r-lg"></div>
            <div class="absolute left-4 top-16 w-8 h-12 bg-[#1a1a1a] rounded-l-lg"></div>
            <div class="absolute right-4 top-16 w-8 h-12 bg-[#1a1a1a] rounded-r-lg"></div>
        </div>

        <!-- Fingerboard -->
        <div class="relative flex-grow w-3/5 bg-black fingerboard-shadow flex justify-between px-[8%] py-0 overflow-hidden" id="fingerboard">
            
            <div id="tutorial-dot" class="tutorial-target hidden"></div>

            <div id="markers-container" class="absolute inset-0 opacity-30 pointer-events-none">
                <div class="marker w-full h-[2px] bg-blue-400 absolute top-[14.2%]"></div>
                <div class="marker w-full h-[2px] bg-yellow-400 absolute top-[28.5%]"></div>
                <div class="marker w-full h-[2px] bg-red-400 absolute top-[35.7%]"></div>
                <div class="marker w-full h-[2px] bg-green-400 absolute top-[50%]"></div>
            </div>

            <!-- Strings -->
            <div class="string relative h-full w-2 bg-gray-400 opacity-80 rounded-full cursor-pointer transition-colors" 
                 data-note="G3" data-base-freq="196.00" id="string-g">
                 <div class="absolute inset-0 w-full h-full hover:bg-white/10"></div>
            </div>

            <div class="string relative h-full w-[6px] bg-gray-400 opacity-80 rounded-full cursor-pointer transition-colors" 
                 data-note="D4" data-base-freq="293.66" id="string-d">
                 <div class="absolute inset-0 w-full h-full hover:bg-white/10"></div>
            </div>

            <div class="string relative h-full w-1 bg-gray-400 opacity-80 rounded-full cursor-pointer transition-colors" 
                 data-note="A4" data-base-freq="440.00" id="string-a">
                 <div class="absolute inset-0 w-full h-full hover:bg-white/10"></div>
            </div>

            <div class="string relative h-full w-[2px] bg-gray-300 opacity-90 rounded-full cursor-pointer transition-colors" 
                 data-note="E5" data-base-freq="659.25" id="string-e">
                 <div class="absolute inset-0 w-full h-full hover:bg-white/10"></div>
            </div>

        </div>

        <!-- Bridge -->
        <div class="w-4/5 h-16 bg-[#e6d6aa] rounded-t-[40%] border-t-4 border-[#d4c490] shadow-lg z-10 mt-[-10px] flex justify-between px-[18%] items-end pb-4">
             <div class="w-1 h-1 bg-black rounded-full opacity-50"></div>
             <div class="w-1 h-1 bg-black rounded-full opacity-50"></div>
             <div class="w-1 h-1 bg-black rounded-full opacity-50"></div>
             <div class="w-1 h-1 bg-black rounded-full opacity-50"></div>
        </div>

        <!-- Tailpiece -->
        <div class="w-2/5 h-32 bg-black rounded-b-3xl mt-[-5px] shadow-xl flex flex-col items-center pt-4 opacity-95">
             <div class="w-2 h-2 bg-yellow-400 rounded-full mb-2"></div>
        </div>

    </div>

    <div class="absolute bottom-4 text-stone-500 text-sm pointer-events-none text-center px-4">
        Hold & slide on strings to play.<br>Higher up (top) = Open String.
    </div>

    <script>
        // -------------------------------------------------------------------------
        // SETUP: API KEY IS OPTIONAL NOW FOR OFFLINE SONGS
        // -------------------------------------------------------------------------
        const apiKey = "";

        // --- Audio Engine ---
        let audioCtx;
        let isAudioStarted = false;
        const voices = {}; // renamed and used throughout
        let bowNoiseBuffer = null;

        function createBowNoise() {
            if (!audioCtx) return null;
            const bufferSize = audioCtx.sampleRate * 2;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            let lastOut = 0;
            for (let i = 0; i < bufferSize; i++) {
                const white = Math.random() * 2 - 1;
                data[i] = (lastOut + (0.02 * white)) / 1.02;
                lastOut = data[i];
                data[i] *= 3.5;
            }
            return buffer;
        }

        async function createReverb() {
            const sampleRate = audioCtx.sampleRate;
            const length = 2.5 * sampleRate;
            const impulse = audioCtx.createBuffer(2, length, sampleRate);
            const left = impulse.getChannelData(0);
            const right = impulse.getChannelData(1);
            for (let i = 0; i < length; i++) {
                const decay = Math.pow(1 - i / length, 2.0);
                left[i] = (Math.random() * 2 - 1) * decay;
                right[i] = (Math.random() * 2 - 1) * decay;
            }
            const convolver = audioCtx.createConvolver();
            convolver.buffer = impulse;
            return convolver;
        }

        let mainGain;
        let reverbNode;

        async function initAudio() {
            if (isAudioStarted) return;
            console.log("Initializing Audio...");

            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) throw new Error("Web Audio API not supported");

                audioCtx = new AudioContext();

                if (audioCtx.state === 'suspended') {
                    await audioCtx.resume();
                }

                bowNoiseBuffer = createBowNoise();

                const compressor = audioCtx.createDynamicsCompressor();
                compressor.threshold.value = -24;
                compressor.knee.value = 30;
                compressor.ratio.value = 12;
                compressor.attack.value = 0.003;
                compressor.release.value = 0.25;

                mainGain = audioCtx.createGain();
                mainGain.gain.value = 0.5;

                reverbNode = await createReverb();
                const reverbGain = audioCtx.createGain();
                reverbGain.gain.value = 0.35;

                mainGain.connect(compressor);
                compressor.connect(audioCtx.destination);

                mainGain.connect(reverbNode);
                reverbNode.connect(audioCtx.destination);

                isAudioStarted = true;
                console.log("Audio Engine Started Successfully");
            } catch (e) {
                console.error("Audio Init Error:", e);
                alert("Audio initialization failed. App will run in silent mode.");
            }

            const overlay = document.getElementById('start-overlay');
            if (overlay) {
                overlay.style.transition = "opacity 0.5s";
                overlay.style.opacity = '0';
                setTimeout(() => overlay.remove(), 500);
            }
        }

        // --- Cello Voice (Background) ---
        class CelloVoice {
            constructor(freq) {
                this.osc = audioCtx.createOscillator();
                this.gain = audioCtx.createGain();
                this.filter = audioCtx.createBiquadFilter();

                this.osc.type = 'sawtooth';
                this.osc.frequency.value = freq / 2;

                this.filter.type = 'lowpass';
                this.filter.frequency.value = 200;
                this.filter.Q.value = 1;

                this.osc.connect(this.filter);
                this.filter.connect(this.gain);
                this.gain.connect(mainGain);

                this.gain.gain.value = 0;
                this.osc.start();
            }

            start() {
                const time = audioCtx.currentTime;
                this.gain.gain.cancelScheduledValues(time);
                this.gain.gain.setValueAtTime(0, time);
                this.gain.gain.linearRampToValueAtTime(0.2, time + 2.0);
            }

            stop() {
                const time = audioCtx.currentTime;
                this.gain.gain.cancelScheduledValues(time);
                this.gain.gain.setValueAtTime(this.gain.gain.value, time);
                this.gain.gain.linearRampToValueAtTime(0, time + 2.0);
                // do not stop oscillator to allow reuse; let it run quietly
            }
        }

        // --- Realistic Violin Voice Class ---
        class ViolinVoice {
            constructor(baseFreq) {
                this.baseFreq = baseFreq;

                this.osc1 = audioCtx.createOscillator();
                this.osc2 = audioCtx.createOscillator();
                this.osc3 = audioCtx.createOscillator();

                // Noise buffer source - create once and loop
                this.noiseNode = audioCtx.createBufferSource();
                this.noiseNode.buffer = bowNoiseBuffer;
                this.noiseNode.loop = true;

                this.noiseGain = audioCtx.createGain();
                this.noiseFilter = audioCtx.createBiquadFilter();

                this.gain = audioCtx.createGain();

                // FORMANT FILTER CHAIN
                this.fA0 = audioCtx.createBiquadFilter();
                this.fA0.type = 'bandpass';
                this.fA0.frequency.value = 280;
                this.fA0.Q.value = 1.0;

                this.fWood = audioCtx.createBiquadFilter();
                this.fWood.type = 'peaking';
                this.fWood.frequency.value = 500;
                this.fWood.Q.value = 2.0;
                this.fWood.gain.value = 5;

                this.fBridge = audioCtx.createBiquadFilter();
                this.fBridge.type = 'peaking';
                this.fBridge.frequency.value = 2500;
                this.fBridge.Q.value = 1.0;
                this.fBridge.gain.value = 4;

                this.fCut = audioCtx.createBiquadFilter();
                this.fCut.type = 'lowpass';
                this.fCut.frequency.value = 4000;
                this.fCut.Q.value = 0.5;

                this.lfo = audioCtx.createOscillator();
                this.lfoGain = audioCtx.createGain();

                this.osc1.type = 'sawtooth';
                this.osc2.type = 'sawtooth';
                this.osc3.type = 'triangle';

                this.osc2.detune.value = 8;
                this.osc3.detune.value = -5;

                this.lfo.frequency.value = 6.0;
                this.lfoGain.gain.value = 0;

                // connections
                this.lfo.connect(this.lfoGain);
                this.lfoGain.connect(this.osc1.frequency);
                this.lfoGain.connect(this.osc2.frequency);
                this.lfoGain.connect(this.osc3.frequency);

                this.osc1.connect(this.fCut);
                this.osc2.connect(this.fCut);

                const subGain = audioCtx.createGain();
                subGain.gain.value = 0.6;
                this.osc3.connect(subGain);
                subGain.connect(this.fCut);

                this.fCut.connect(this.fWood);
                this.fWood.connect(this.fBridge);
                this.fBridge.connect(this.gain);

                this.noiseFilter.type = 'bandpass';
                this.noiseFilter.frequency.value = 1000;
                this.noiseFilter.Q.value = 1;
                this.noiseNode.connect(this.noiseFilter);
                this.noiseFilter.connect(this.noiseGain);
                this.noiseGain.connect(mainGain);

                this.gain.connect(mainGain);
                this.gain.gain.value = 0;
                this.noiseGain.gain.value = 0;

                // start sources once
                this.osc1.start();
                this.osc2.start();
                this.osc3.start();
                // only start noiseNode if buffer exists
                try {
                    if (bowNoiseBuffer) this.noiseNode.start();
                } catch (e) {
                    // if noiseNode can't be started for some reason, ignore
                    console.warn("Bow noise start skipped:", e);
                }
                this.lfo.start();
            }

            play(freqRatio) {
                const targetFreq = this.baseFreq * freqRatio;
                const time = audioCtx.currentTime;

                this.osc1.frequency.setTargetAtTime(targetFreq, time, 0.03);
                this.osc2.frequency.setTargetAtTime(targetFreq, time, 0.03);
                this.osc3.frequency.setTargetAtTime(targetFreq, time, 0.03);

                const vibratoAmount = freqRatio > 1.05 ? (targetFreq * 0.015) : 0;
                this.lfoGain.gain.cancelScheduledValues(time);
                this.lfoGain.gain.setValueAtTime(0, time);
                this.lfoGain.gain.linearRampToValueAtTime(vibratoAmount, time + 0.25);

                this.gain.gain.cancelScheduledValues(time);
                this.gain.gain.setValueAtTime(this.gain.gain.value, time);
                this.gain.gain.linearRampToValueAtTime(0.5, time + 0.1);

                this.noiseGain.gain.cancelScheduledValues(time);
                this.noiseGain.gain.setValueAtTime(0.15, time);
                // noise quick fade
                this.noiseGain.gain.exponentialRampToValueAtTime(0.001, time + 0.15);
            }

            stop() {
                const time = audioCtx.currentTime;
                this.gain.gain.cancelScheduledValues(time);
                this.gain.gain.setValueAtTime(this.gain.gain.value, time);
                this.gain.gain.linearRampToValueAtTime(0, time + 0.2);

                this.noiseGain.gain.cancelScheduledValues(time);
                this.noiseGain.gain.setValueAtTime(this.noiseGain.gain.value, time);
                this.noiseGain.gain.linearRampToValueAtTime(0, time + 0.1);

                // IMPORTANT: do not stop internal oscillator/buffer sources here so the voice can be reused.
            }

            dispose() {
                // If you later want to free resources, implement stopping and disconnecting here.
            }
        }

        // --- OFFLINE SONG LIBRARY ---
        const offlineLibrary = {
            "harry potter": {
                root_freq: 164,
                notes: [
                    {string:"string-d", semitones:2, name:"E"}, {string:"string-d", semitones:5, name:"G"}, {string:"string-d", semitones:4, name:"F#"}, {string:"string-d", semitones:2, name:"E"},
                    {string:"string-a", semitones:2, name:"B"}, {string:"string-a", semitones:0, name:"A"}, {string:"string-d", semitones:4, name:"F#"},
                    {string:"string-d", semitones:2, name:"E"}, {string:"string-d", semitones:5, name:"G"}, {string:"string-d", semitones:4, name:"F#"}, {string:"string-d", semitones:0, name:"Eb/D#"},
                    {string:"string-d", semitones:3, name:"F"}, {string:"string-d", semitones:2, name:"B (Low)"}
                ]
            },
            "pirates": {
                root_freq: 293,
                notes: [
                    {string:"string-d", semitones:0, name:"D"}, {string:"string-d", semitones:0, name:"D"}, {string:"string-d", semitones:2, name:"E"}, {string:"string-d", semitones:3, name:"F"},
                    {string:"string-d", semitones:3, name:"F"}, {string:"string-d", semitones:3, name:"F"}, {string:"string-d", semitones:5, name:"G"}, {string:"string-a", semitones:0, name:"A"},
                    {string:"string-a", semitones:0, name:"A"}, {string:"string-d", semitones:0, name:"D"}, {string:"string-d", semitones:2, name:"E"}, {string:"string-d", semitones:3, name:"F"}
                ]
            },
            "happy birthday": {
                root_freq: 196,
                notes: [
                    {string:"string-d", semitones:0, name:"D"}, {string:"string-d", semitones:0, name:"D"}, {string:"string-d", semitones:2, name:"E"}, {string:"string-d", semitones:0, name:"D"}, {string:"string-d", semitones:5, name:"G"}, {string:"string-d", semitones:4, name:"F#"},
                    {string:"string-d", semitones:0, name:"D"}, {string:"string-d", semitones:0, name:"D"}, {string:"string-d", semitones:2, name:"E"}, {string:"string-d", semitones:0, name:"D"}, {string:"string-a", semitones:0, name:"A"}, {string:"string-d", semitones:5, name:"G"}
                ]
            },
            "abhi": {
                root_freq: 146,
                notes: [
                    { string: 'string-g', semitones: 2, name: "1st (A)" }, 
                    { string: 'string-d', semitones: 0, name: "Open D" },
                    { string: 'string-d', semitones: 2, name: "1st (E)" },
                    { string: 'string-d', semitones: 3, name: "Low 2nd (F)" },
                    { string: 'string-d', semitones: 2, name: "1st (E)" },
                    { string: 'string-d', semitones: 0, name: "Open D" },
                    { string: 'string-d', semitones: 2, name: "1st (E)" },
                    { string: 'string-d', semitones: 3, name: "Low 2nd (F)" },
                    { string: 'string-d', semitones: 5, name: "3rd (G)" },
                    { string: 'string-a', semitones: 0, name: "Open A" },
                    { string: 'string-d', semitones: 5, name: "3rd (G)" },
                    { string: 'string-d', semitones: 3, name: "Low 2nd (F)" },
                    { string: 'string-d', semitones: 2, name: "1st (E)" },
                    { string: 'string-d', semitones: 0, name: "Open D" }
                ]
            },
            "taqdeer": {
                root_freq: 146,
                notes: [
                    { string: 'string-d', semitones: 0, name: "Open D" },
                    { string: 'string-d', semitones: 3, name: "Low 2nd (F)" },
                    { string: 'string-d', semitones: 2, name: "1st (E)" },
                    { string: 'string-d', semitones: 0, name: "Open D" },
                    { string: 'string-g', semitones: 2, name: "1st (A)" },
                    { string: 'string-g', semitones: 6, name: "3rd+ (C#)" },
                    { string: 'string-d', semitones: 0, name: "Open D" }
                ]
            },
            "manwa laage": {
                root_freq: 220,
                notes: [
                    { string: 'string-d', semitones: 3, name: "F" }, { string: 'string-d', semitones: 2, name: "E" }, { string: 'string-d', semitones: 3, name: "F" }, { string: 'string-d', semitones: 2, name: "E" }, { string: 'string-d', semitones: 0, name: "D" },
                    { string: 'string-d', semitones: 3, name: "F" }, { string: 'string-d', semitones: 2, name: "E" }, { string: 'string-d', semitones: 3, name: "F" }, { string: 'string-d', semitones: 2, name: "E" }, { string: 'string-d', semitones: 0, name: "D" }
                ]
            },
            "jingle bells": {
                root_freq: 261,
                notes: [
                    {string:"string-d", semitones:4, name:"F#"}, {string:"string-d", semitones:4, name:"F#"}, {string:"string-d", semitones:4, name:"F#"},
                    {string:"string-d", semitones:4, name:"F#"}, {string:"string-d", semitones:4, name:"F#"}, {string:"string-d", semitones:4, name:"F#"},
                    {string:"string-d", semitones:4, name:"F#"}, {string:"string-a", semitones:0, name:"A"}, {string:"string-d", semitones:0, name:"D"}, {string:"string-d", semitones:2, name:"E"}, {string:"string-d", semitones:4, name:"F#"}
                ]
            }
        };

        const twinkleData = [
            { string: 'string-d', semitones: 0, name: "Open D" },
            { string: 'string-d', semitones: 0, name: "Open D" },
            { string: 'string-a', semitones: 0, name: "Open A" },
            { string: 'string-a', semitones: 0, name: "Open A" },
            { string: 'string-a', semitones: 2, name: "1st Finger A (B)" },
            { string: 'string-a', semitones: 2, name: "1st Finger A (B)" },
            { string: 'string-a', semitones: 0, name: "Open A" },
            { string: 'string-d', semitones: 5, name: "3rd Finger D (G)" },
            { string: 'string-d', semitones: 5, name: "3rd Finger D (G)" },
            { string: 'string-d', semitones: 4, name: "2nd Finger D (F#)" },
            { string: 'string-d', semitones: 4, name: "2nd Finger D (F#)" },
            { string: 'string-d', semitones: 2, name: "1st Finger D (E)" },
            { string: 'string-d', semitones: 2, name: "1st Finger D (E)" },
            { string: 'string-d', semitones: 0, name: "Open D" }
        ];

        let currentSongData = twinkleData;
        let currentBackingFreq = null;
        let tutorialActive = false;
        let isDemoPlaying = false;
        let currentStep = 0;
        let stepCompleted = false;
        let activeCello = null;
        let activeSessionId = 0;

        const tutorialDot = document.getElementById('tutorial-dot');
        const tutorialStatus = document.getElementById('tutorial-status');
        const tutorialMsg = document.getElementById('tutorial-msg');
        const stopBtn = document.getElementById('stop-btn');

        function stopTutorial() {
            activeSessionId++;
            tutorialActive = false;
            isDemoPlaying = false;
            stepCompleted = false;

            if (activeCello) {
                activeCello.stop();
                activeCello = null;
            }

            Object.values(voices).forEach(v => {
                try { v.stop(); } catch (e) {}
            });
            document.querySelectorAll('.string').forEach(s => s.classList.remove('playing'));
            tutorialDot.classList.add('hidden');
            tutorialStatus.classList.add('hidden');
            stopBtn.classList.add('hidden');
        }

        async function playDemo(data, sessionId, isPerformance = false) {
            isDemoPlaying = true;
            tutorialMsg.innerText = isPerformance ? "Performing..." : "Listen first...";
            tutorialStatus.classList.remove('hidden');
            stopBtn.classList.remove('hidden');

            if (isPerformance && currentBackingFreq) {
                activeCello = new CelloVoice(currentBackingFreq);
                activeCello.start();
                await new Promise(r => setTimeout(r, 1000));
            }

            for (const note of data) {
                if (sessionId !== activeSessionId) return;

                const stringEl = document.getElementById(note.string);
                const fingerboard = document.getElementById('fingerboard');
                const fbRect = fingerboard.getBoundingClientRect();
                const strRect = stringEl.getBoundingClientRect();
                const percentage = note.semitones / 14;
                const x = (strRect.left + strRect.width/2) - fbRect.left;
                let yPercent = percentage * 100;
                if (note.semitones === 0) yPercent = 2;

                tutorialDot.style.left = x + 'px';
                tutorialDot.style.top = yPercent + '%';
                tutorialDot.classList.remove('hidden');
                tutorialDot.style.borderColor = '#fbbf24';
                tutorialMsg.innerText = isPerformance ? `Playing: ${note.name}` : `Listen: ${note.name}`;

                const baseFreq = parseFloat(stringEl.dataset.baseFreq);
                if (!voices[note.string]) {
                    voices[note.string] = new ViolinVoice(baseFreq);
                }

                const ratio = Math.pow(2, note.semitones / 12);
                voices[note.string].play(ratio);
                stringEl.classList.add('playing');

                await new Promise(r => setTimeout(r, 500));
                if (sessionId !== activeSessionId) return;

                voices[note.string].stop();
                stringEl.classList.remove('playing');

                await new Promise(r => setTimeout(r, 100));
            }

            if (sessionId !== activeSessionId) return;

            if (isPerformance) {
                tutorialMsg.innerText = "Performance Complete ðŸ‘";
                tutorialDot.classList.add('hidden');
                isDemoPlaying = false;
                if (activeCello) activeCello.stop();

                setTimeout(() => {
                    if (sessionId === activeSessionId) stopTutorial();
                }, 3000);
                return;
            }

            tutorialMsg.innerText = "Now your turn!";
            tutorialDot.style.borderColor = '#4ade80';
            isDemoPlaying = false;

            await new Promise(r => setTimeout(r, 1000));
            if (sessionId !== activeSessionId) return;

            currentStep = 0;
            stepCompleted = false;
            showStep(sessionId);
        }

        // startTutorial now async to await audio init
        async function startTutorial(data, isPerformance = false, backingFreq = null) {
            if (!isAudioStarted) await initAudio();
            stopTutorial();

            activeSessionId++;
            const thisSessionId = activeSessionId;

            currentSongData = data;
            currentBackingFreq = backingFreq;
            tutorialActive = true;

            playDemo(data, thisSessionId, isPerformance);
        }

        function showStep(sessionId) {
            if (sessionId !== undefined && sessionId !== activeSessionId) return;

            if (currentStep >= currentSongData.length) {
                tutorialMsg.innerText = "Song Complete! Great job!";
                tutorialDot.classList.add('hidden');
                setTimeout(() => {
                    if (sessionId === undefined || sessionId === activeSessionId) {
                        stopTutorial();
                    }
                }, 3000);
                return;
            }

            const note = currentSongData[currentStep];
            tutorialMsg.innerText = `${note.name}`;
            stepCompleted = false;

            const stringEl = document.getElementById(note.string);
            const fingerboard = document.getElementById('fingerboard');
            const fbRect = fingerboard.getBoundingClientRect();
            const strRect = stringEl.getBoundingClientRect();

            const percentage = note.semitones / 14;
            const x = (strRect.left + strRect.width/2) - fbRect.left;
            let yPercent = percentage * 100;
            if (note.semitones === 0) yPercent = 2;

            tutorialDot.style.left = x + 'px';
            tutorialDot.style.top = yPercent + '%';
            tutorialDot.classList.remove('hidden');
            tutorialDot.style.borderColor = '#4ade80';
        }

        function checkTutorialHit(stringId, playedSemitones) {
            if (!tutorialActive || stepCompleted || isDemoPlaying) return;

            const target = currentSongData[currentStep];
            if (stringId !== target.string) return;

            const tolerance = 0.7;

            if (Math.abs(playedSemitones - target.semitones) < tolerance) {
                stepCompleted = true;
                tutorialMsg.innerText = "Good!";
                tutorialMsg.style.color = "#fff";
                tutorialDot.style.borderColor = "#fff";

                setTimeout(() => {
                    if (tutorialActive) {
                        currentStep++;
                        tutorialMsg.style.color = "";
                        showStep();
                    }
                }, 500);
            }
        }

        // --- GEMINI API INTEGRATION ---
        const modal = document.getElementById('ai-modal');
        const openModalBtn = document.getElementById('open-ai-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const btnTeach = document.getElementById('btn-teach');
        const btnPerform = document.getElementById('btn-perform');
        const loadingState = document.getElementById('loading-state');
        const loadingText = document.getElementById('loading-text');
        const songInput = document.getElementById('song-request');

        openModalBtn.addEventListener('click', () => {
            modal.classList.remove('hidden');
            songInput.focus();
        });
        closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.classList.add('hidden');
        });
        document.querySelectorAll('.quick-pick').forEach(btn => {
            btn.addEventListener('click', () => {
                songInput.value = btn.innerText;
            });
        });

        async function callGemini(promptText, isPerformance) {
            if (!promptText) return;

            const lowerPrompt = promptText.toLowerCase();
            let offlineHit = null;

            for (const key in offlineLibrary) {
                if (lowerPrompt.includes(key)) {
                    offlineHit = offlineLibrary[key];
                    break;
                }
            }

            if (offlineHit) {
                modal.classList.add('hidden');
                await startTutorial(offlineHit.notes, isPerformance, isPerformance ? offlineHit.root_freq : null);
                return;
            }

            if (!apiKey || apiKey === "") {
                alert("AI features require an API Key. However, you can play built-in songs like 'Abhi', 'Harry Potter', 'Pirates', 'Happy Birthday', 'Taqdeer' or 'Manwa Laage' without one! Just type them in.");
                return;
            }

            try {
                loadingState.classList.remove('hidden');
                btnTeach.classList.add('hidden');
                btnPerform.classList.add('hidden');
                loadingText.innerText = isPerformance ? "Composing Full Performance..." : "Creating Tutorial...";

                const instruction = isPerformance
                    ? "3. Generate a LONG sequence (30-60 notes). Ensure musical flow. ALSO return the 'root_freq' (integer Hz) of the song's key (e.g. 293 for D, 196 for G, 220 for A, 261 for C) so I can play a cello drone."
                    : "3. Keep melody simple (8-16 notes).";

                const formatDesc = isPerformance
                    ? 'OUTPUT JSON OBJECT: { "notes": [ { "string": "...", "semitones": 0, "name": "..." } ], "root_freq": 293 }'
                    : 'OUTPUT JSON OBJECT: { "notes": [ ... ] }';

                const systemPrompt = `You are a virtual violin teacher. Generate JSON notes for: ${promptText}.
                Strings: G3 ('string-g'), D4 ('string-d'), A4 ('string-a'), E5 ('string-e').
                Rules:
                1. Map melody to First Position.
                2. Calculate semitones (0=Open, 2=1st, 4=2nd, etc).
                ${instruction}
                ${formatDesc}
                Strict JSON. No markdown.`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: "Generate." }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                if (!response.ok) throw new Error('API Error');

                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                const data = JSON.parse(text);

                let songNotes = [];
                let backingFreq = null;

                if (Array.isArray(data)) {
                    songNotes = data;
                } else {
                    songNotes = data.notes;
                    backingFreq = data.root_freq;
                }

                modal.classList.add('hidden');
                await startTutorial(songNotes, isPerformance, backingFreq);

            } catch (error) {
                console.error(error);
                alert("Maestro is having trouble. Check your API key or internet connection.");
            } finally {
                loadingState.classList.add('hidden');
                btnTeach.classList.remove('hidden');
                btnPerform.classList.remove('hidden');
            }
        }

        btnTeach.addEventListener('click', () => callGemini(songInput.value, false));
        btnPerform.addEventListener('click', () => callGemini(songInput.value, true));
        songInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') callGemini(songInput.value, true);
        });

        // Input handling: mouse + touch
        function handleInput(e, str, end = false) {
            // Minimal: detect vertical position on fingerboard and compute semitone approximation.
            const fingerboard = document.getElementById('fingerboard');
            const fbRect = fingerboard.getBoundingClientRect();
            const strRect = str.getBoundingClientRect();
            let clientY;
            if (e && e.touches && e.touches[0]) clientY = e.touches[0].clientY;
            else if (e && e.clientY) clientY = e.clientY;
            else if (end) {
                // On release: stop voice
                if (voices[str.id]) voices[str.id].stop();
                str.classList.remove('playing');
                return;
            } else return;

            // map Y to semitones (simple linear mapping first-position)
            const relative = Math.max(0, Math.min(1, (clientY - fbRect.top) / fbRect.height));
            const semitones = Math.round((1 - relative) * 7); // map to 0..7 (approx)
            if (!voices[str.id]) {
                const baseFreq = parseFloat(str.dataset.baseFreq);
                voices[str.id] = new ViolinVoice(baseFreq);
            }
            const ratio = Math.pow(2, semitones / 12);
            voices[str.id].play(ratio);
            str.classList.add('playing');

            // If tutorial active check hit:
            checkTutorialHit(str.id, semitones);
        }

        const stringsInput = document.querySelectorAll('.string');
        stringsInput.forEach(str => {
            str.addEventListener('mousedown', (e) => {
                handleInput(e, str);
                const moveHandler = (ev) => handleInput(ev, str);
                const upHandler = () => {
                    handleInput(null, str, true);
                    window.removeEventListener('mousemove', moveHandler);
                    window.removeEventListener('mouseup', upHandler);
                };
                window.addEventListener('mousemove', moveHandler);
                window.addEventListener('mouseup', upHandler);
            });
            str.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(e, str); });
            str.addEventListener('touchmove', (e) => { e.preventDefault(); handleInput(e, str); });
            str.addEventListener('touchend', (e) => { e.preventDefault(); handleInput(e, str, true); });
        });

        const toggleBtn = document.getElementById('toggle-markers');
        const markersContainer = document.getElementById('markers-container');
        toggleBtn.addEventListener('click', () => {
            if (markersContainer.style.display === 'none') {
                markersContainer.style.display = 'block';
                toggleBtn.innerText = 'Hide Tapes';
            } else {
                markersContainer.style.display = 'none';
                toggleBtn.innerText = 'Show Tapes';
            }
        });
        toggleBtn.innerText = 'Hide Tapes';

        // Start overlay click to unlock audio (user gesture)
        const overlay = document.getElementById('start-overlay');
        if (overlay) {
            overlay.addEventListener('click', async () => {
                await initAudio();
            }, { once: true });
        }

        // Start tutorial button (quick action)
        document.getElementById('start-tutorial').addEventListener('click', () => {
            startTutorial(twinkleData, false);
        });

    </script>
</body>
</html>
